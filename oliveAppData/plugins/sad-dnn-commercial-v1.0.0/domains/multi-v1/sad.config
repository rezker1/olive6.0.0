from idento3 import Pncc, Wave, WavException, WaveTooShortException, AudioQuality, External, FeatProcess, Feature, frames_from_signal
from idento3 import preemphasis as idtpreem

from idento3 import extend_array_borders, splice
import numpy as np

def wmvn(data, win):
    ndata = np.empty_like(data.astype('f'))
    nb_ex, dim = data.shape
    mwin = min((nb_ex//2)*2-1, win)
    new_data = extend_array_borders(data, mwin, mode="reflect")
    ffs = frames_from_signal(new_data, mwin, 1)
    ndata = (data.astype('f')-ffs.mean(2).astype('f')) / ffs.std(2).astype('f')
    return ndata.astype('f')

def pp(feat, indices=None):
    window = 31
    window_norm = 201
    feat = feat[:,1:]
    
    feat = wmvn(feat, window_norm)

    return splice(feat,window).astype('f')

featclass   = Pncc
window      = 200
overlap     = 120
sample_rate = 8000
min_rms     = 0.0
min_duration = 0.31
normalize   = True
fstart      = 200
fend        = 3300
nfilters    = 40
ncep        = 21
nfft        = 512
preemphasis = None
addenergy   = False
includeC0   = True

featprocess_func = pp

vad_padding = 0.3
vad_interpolate = 4
